#!/usr/bin/env python
import pdb
from pathlib import Path

import cv2


def ratio_bbox_to_xyxy(bbox, H, W):
    x1, y1, x2, y2 = bbox
    x1 = int(x1 * W)
    y1 = int(y1 * H)
    x2 = int(x2 * W)
    y2 = int(y2 * H)
    return [x1, y1, x2, y2]


def draw_bbox(im, bboxes):
    for bbox in bboxes:
        x1, y1, x2, y2 = bbox
        cv2.rectangle(im, (x1, y1), (x2, y2), (0, 255, 0), 5)
        cv2.putText(im, "Object", (x2 + 10, y2), 0, 0.3, (0, 255, 0))

    H, W = im.shape[:2]
    # im = cv2.resize(
    #     im,
    #     (int(W / 2), int(H / 2)),
    # )


def draw_bulb_centroids(im, bulb_centroids):
    H, W = im.shape[:2]
    for x, y in bulb_centroids:
        cv2.circle(im, (int(x * W), int(y * H)), 10, (255, 0, 0), 3)


# ========================= Draw bbox ========================
# img_path = "/home/ztlevi/Developer/Github/tfmtcnn/data/CelebA/images/000001.jpg"
# im = cv2.imread(img_path)
# bboxes = [[95, 71, 226, 313]]

# draw_bbox(im, bboxes)

# ========================= Draw bbox with ratio ==========================
# img_path = '/media/ztlevi/Disk2/data/argo/data_TL-small_test_dataset-3/training/563fac54-0e3f-3c0e-9aee-4e8b5b237513/images/563fac54-0e3f-3c0e-9aee-4e8b5b237513_122_1.png'
# im = cv2.imread(img_path)
# draw_ratio_bbox(im, bboxes)

bboxes = [
    [0.56451575575932, 0.475547634937279, 0.556605233265233, 0.473678276788195],
    [0.325417007160026, 0.363865470461607, 0.254887837309352, 0.351310107804819],
    [0.445289200829603, 0.359386884778084, 0.402462961285924, 0.348415992007487],
    [0.537037195974852, 0.475879991671547, 0.529507624804514, 0.474032799798125],
]
bulb_centroids = [
    [0.561096885290699, 0.474757250971002],
    [0.557988659028392, 0.474635054449744],
    [0.56339146804119, 0.474805490490089],
    [0.561055848044503, 0.474650739329441],
    [0.56083918148709, 0.474671897151193],
    [0.56315990933027, 0.474637354526272],
    [0.558005572418509, 0.474733131211458],
    [0.557988659028392, 0.474635054449744],
    [0.563481740468048, 0.474705217034951],
    [0.273920558087146, 0.358060521638463],
    [0.316490926556752, 0.356745467319286],
    [0.260193786213273, 0.358498873078188],
    [0.301751862546888, 0.357344393798078],
    [0.301751862546888, 0.357344393798078],
    [0.260177601860265, 0.358551850248563],
    [0.316673549791071, 0.356634125297793],
    [0.274066971119001, 0.358054662298363],
    [0.274066971119001, 0.358054662298363],
    [0.260177601860265, 0.358551850248563],
    [0.302474560339549, 0.357227653902984],
    [0.287862493288151, 0.357983635448335],
    [0.287589411092353, 0.357972851350518],
    [0.316673549791071, 0.356634125297793],
    [0.287862493288151, 0.357983635448335],
    [0.42277142311867, 0.353604242693253],
    [0.42277142311867, 0.353604242693253],
    [0.436967312774192, 0.353314196080019],
    [0.437673378499844, 0.353142629409243],
    [0.408017827912751, 0.354290424601917],
    [0.408017827912751, 0.354290424601917],
    [0.408418921339065, 0.354629813099012],
    [0.437673378499844, 0.353142629409243],
    [0.422726546086412, 0.353719001316632],
    [0.535891366427551, 0.474965426309444],
    [0.530502724527234, 0.475033969564546],
    [0.535891366427551, 0.474965426309444],
    [0.533287077712728, 0.474979419759799],
    [0.533287077712728, 0.474979419759799],
    [0.533129121419826, 0.475068241192097],
    [0.530502724527234, 0.475033969564546],
    [0.535891366427551, 0.474965426309444],
    [0.530502724527234, 0.475033969564546],
]

print(len(bulb_centroids))
print(len(set([tuple(l) for l in bulb_centroids])))

img_path = "/data/tl_0.png"
img_path = "/Users/ztlevi/Downloads/bulb_rotation/bulb_rotation/1587412811_34165.jpg"
im = cv2.imread(img_path)

H, W = im.shape[:2]  # It's H,W !!!
bboxes = [ratio_bbox_to_xyxy(bbox, H, W) for bbox in bboxes]
draw_bbox(im, bboxes)
draw_bulb_centroids(im, bulb_centroids)

cv2.imwrite("/data/tl_1.png", im)
